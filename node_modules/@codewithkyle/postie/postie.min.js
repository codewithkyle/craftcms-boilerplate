(()=>{var o=class{constructor(){this.observe=e=>{e.forEach(t=>{t.isIntersecting&&(this.processElement(t.target),this.io.unobserve(t.target))})};this.handleClick=e=>{let t=e.target;t.getAttribute("postie")!==null&&t.getAttribute("disabled")===null&&(t.getAttribute("trigger")?.toLowerCase()==="click"||t.getAttribute("trigger")===null)&&(this.preventDefault(t,e),this.beforeProcessElement(t))};this.handleKeypress=e=>{if(e instanceof KeyboardEvent){let t=e.target,r=t.getAttribute("trigger")?.toLowerCase()??null;if(t.getAttribute("postie")!==null&&t.getAttribute("disabled")===null){let i=e.key.toLowerCase();r==="keypress"||r==="keyup"||r==="keydown"||r==="key"?t.getAttribute("key")?.toLowerCase()===i&&(this.preventDefault(t,e),this.beforeProcessElement(t)):(r==="click"||r===null&&i==="enter"||i==="")&&(this.preventDefault(t,e),this.beforeProcessElement(t))}}};this.io=new IntersectionObserver(this.observe.bind(this)),this.main()}beforeProcessElement(e){let t=!0;e.getAttribute("once")!==null&&e.getAttribute("postie-uid")!==null&&(t=!1),t&&this.processElement(e)}preventDefault(e,t){e.getAttribute("allow-default")===null&&t.preventDefault()}applyUid(e){e.getAttribute("postie-uid")===null&&e.setAttribute("postie-uid",this.uuid())}handlePrompt(e){switch(e.prompt){case"confirm":if(!confirm(e.promptLabel))throw"User canceled.";return;case"input":let t=prompt(e.promptLabel,e.promptValue);if(t===null)throw"User canceled.";e.data[e.promptName]=t;return;default:return}}validateSettings(e){if(e.endpoint===null||e.prompt!==null&&e.promptLabel===null)throw"Invalid Postie settings."}processElement(e){try{let t={method:e.getAttribute("request")?.toUpperCase()||e.getAttribute("method")?.toUpperCase()||"POST",accept:e.getAttribute("accept")?.toLowerCase()??"application/json",data:e.dataset,endpoint:e.getAttribute("endpoint"),prompt:e.getAttribute("prompt")?.toLowerCase()??null,promptLabel:e.getAttribute("prompt-label"),promptValue:e.getAttribute("prompt-value")??"",promptName:e.getAttribute("prompt-name")??"prompt",success:e.getAttribute("success")||e.getAttribute("onsuccess")||null,error:e.getAttribute("error")||e.getAttribute("onerror")||null,preventDisable:e.getAttribute("no-disable")!==null||e.getAttribute("prevent-disable")!==null||!1,once:e.getAttribute("once")!==null,target:e.getAttribute("target"),swap:e.getAttribute("swap")||"innerHTML",el:e,reset:e.getAttribute("reset")!==null?parseInt(e.getAttribute("reset")):10};this.validateSettings(t),this.handlePrompt(t),this.applyUid(e),this.fetch(t)}catch(t){console.error(t)}}createRequest(e){return fetch(e.endpoint,{method:e.method,credentials:"include",headers:new Headers({Accept:e.accept,"Content-Type":"application/json"}),body:Object.keys(e.data).length?JSON.stringify(e.data):null})}async processResponse(e,t){let r=null;switch(e.accept){case"application/json":r=await t.json();break;case"text/html":r=await t.text();break;default:throw`Invalid accept type: ${e.accept}`}return r}prepareScript(){let e=document.head.querySelector("script#postie");return e&&e.remove(),e=document.createElement("script"),e.id="postie",e}handleSuccessResponse(e,t,r){if(e.success!==null&&(e.accept==="application/json"&&(r.innerHTML+=`const response = JSON.parse(${JSON.stringify(t)});`),r.innerHTML+=e.success),e.accept==="text/html"){let i=e.el;if(e.target!==null&&(i=document.body.querySelector(e.target),!i))throw`Failed to find element matching selector: ${e.target}`;switch(e.swap){case"inner":i.innerHTML=t;break;case"innerHTML":i.innerHTML=t;break;case"outer":i.outerHTML=t;break;case"outerHTML":i.outerHTML=t;break;default:throw`Invalid swap type: ${e.swap}`}this.observeElements()}e.el.setAttribute("postie","success")}handleErrorResponse(e,t,r){e.error!==null&&(e.accept==="application/json"&&(r.innerHTML+=`const response = JSON.parse(${JSON.stringify(t)});`),r.innerHTML+=e.error),e.el.setAttribute("postie","error")}dispatchEvent(e,t=null){let r=new CustomEvent(`postie:${e}`,{detail:t});document.dispatchEvent(r)}reset(e){e.once||e.el.removeAttribute("disabled"),setTimeout(()=>{e.el.setAttribute("postie","idling")},e.reset*1e3)}async fetch(e){try{e.el.setAttribute("postie","processing"),e.preventDisable||e.el.setAttribute("disabled","true");let t=await this.createRequest(e),r=await this.processResponse(e,t),i=this.prepareScript();t.ok?this.handleSuccessResponse(e,r,i):this.handleErrorResponse(e,r,i),i.innerHTML.length&&document.head.appendChild(i),this.dispatchEvent(t.ok?"success":"error",e.accept==="application/json"?r:null)}catch(t){console.error(t),e.el.setAttribute("postie","error"),this.dispatchEvent("error")}this.reset(e)}observeElements(){document.body.querySelectorAll('[postie][trigger="observe"]:not([postie-uid])').forEach(e=>{this.applyUid(e),this.io.observe(e)})}main(){document.addEventListener("click",this.handleClick,{passive:!0,capture:!0}),document.addEventListener("keypress",this.handleKeypress,{passive:!0,capture:!0}),document.addEventListener("postie:update",()=>{this.observeElements()}),this.observeElements()}uuid(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}},n=new o;})();
