var Messenger=(()=>{var __defProp=Object.defineProperty;var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var messaging_exports={};__export(messaging_exports,{message:()=>message,register:()=>register,reply:()=>reply,unregister:()=>unregister});var ActorModel=class{constructor(){this.inboxes={};this.queue=[];this.flushQueue()}flushQueue(){if(this.queue.length){const queue=this.queue.splice(0,this.queue.length);for(let i=queue.length-1;i>=0;i--){if(this.inboxes?.[queue[i].recipient]){const message2={data:queue[i].data,replyId:queue[i].senderId};for(let j=0;j<this.inboxes[queue[i].recipient].length;j++){this.inboxes[queue[i].recipient][j].inbox(message2)}}else{queue[i].attempts++;if(queue[i].attempts>=queue[i].maxAttempts){queue.splice(i,1)}}}this.queue=[...this.queue,...queue]}setTimeout(this.flushQueue.bind(this),1e3)}sendMessage(msg){if(this.inboxes?.[msg.recipient]){const message2={data:msg.data,replyId:msg.senderId};for(let j=0;j<this.inboxes[msg.recipient].length;j++){this.inboxes[msg.recipient][j].inbox(message2)}}else if(msg.maxAttempts>1){this.queue.push(msg)}}uid(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}register(alias,inbox){const inboxId=this.uid();if(!this.inboxes?.[alias]){this.inboxes[alias]=[]}this.inboxes[alias].push({id:inboxId,inbox});return inboxId}unregister(inboxId){let foundInbox=false;for(const alias in this.inboxes){for(let i=0;i<this.inboxes[alias].length;i++){if(this.inboxes[alias][i].id===inboxId){this.inboxes[alias].splice(i,1);foundInbox=true;break}}if(foundInbox){if(this.inboxes[alias].length===0){delete this.inboxes[alias]}break}}}message(message2){const msg=Object.assign({maxAttempts:1,senderId:null,attempts:0,recipient:null,data:null},message2);if(msg.recipient!==null&&msg.data!==null){this.sendMessage(msg)}}reply(replyId,message2){if(replyId===null){console.error("Messaging error: replyId cannot be null");return}let foundInbox=false;for(const alias in this.inboxes){for(let i=0;i<this.inboxes[alias].length;i++){if(this.inboxes[alias][i].id===replyId){const msg={data:message2.data,replyId:message2?.senderId??null};this.inboxes[alias][i].inbox(msg);foundInbox=true;break}}if(foundInbox){break}}}};var messenger=new ActorModel;var register=messenger.register.bind(messenger);var unregister=messenger.unregister.bind(messenger);var message=messenger.message.bind(messenger);var reply=messenger.reply.bind(messenger);return messaging_exports;})();
